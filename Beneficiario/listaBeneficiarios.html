<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Benefici√°rios - Alvorecer Digital</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; background: white; padding: 20px; margin: auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table th, table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        table th { background: #007bff; color: white; }
        .btn { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
        .btn:hover { background: #0056b3; }
        .btn-inicio { display: inline-block; margin-bottom: 20px; padding: 10px 15px; background: #e0e0e0; text-decoration: none; color: #333; border-radius: 5px; font-weight: bold; }
        
        .btn-acao { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-weight: bold; color: white; }
        .btn-editar { background: #28a745; }
        .btn-excluir { background: #dc3545; }
    </style>
</head>
<body>

    <a href="../telainicial.html" class="btn-inicio">‚¨Ö Voltar ao In√≠cio</a>

    <div class="container">
        <h1>Benefici√°rios (Banco de Dados)</h1>
        
        <button class="btn" onclick="window.location.href='alterarddosbeneficiarios.html'">+ Cadastrar Benefici√°rio</button>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Respons√°vel</th>
                    <th>Idade</th>
                    <th>Endere√ßo</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="beneficiariosTabela">
                <tr><td colspan="5" style="text-align:center">Carregando...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        // CHAVES DE CONEX√ÉO COM O BANCO DE DADOS
        const supabaseUrl = 'https://qmbkynoymgmwjxjelkoc.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYmt5bm95bWdtd2p4amVsa29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTkzMjgsImV4cCI6MjA3OTgzNTMyOH0.1aS3mB0md0T2BLMfYasCA9ZCgybvKEjV0qXZE6FV_wA'
        const supabase = createClient(supabaseUrl, supabaseKey)

        async function carregarTabela() {
            const tabela = document.getElementById("beneficiariosTabela");
            
            const { data, error } = await supabase
                .from('beneficiarios')
                .select('*')
                .order('nome_crianca', { ascending: true })

            if (error) {
                tabela.innerHTML = `<tr><td colspan="5">Erro: ${error.message}</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tabela.innerHTML = `<tr><td colspan="5" style="text-align:center">Nenhum benefici√°rio encontrado.</td></tr>`;
                return;
            }

            tabela.innerHTML = "";

            data.forEach(b => {
                const linha = document.createElement("tr");
                linha.innerHTML = `
                    <td>${b.nome_crianca}</td>
                    <td>${b.nome_responsavel}</td>
                    <td>${b.idade}</td>
                    <td>${b.endereco}</td>
                    <td>
                        <button class="btn-acao btn-editar" onclick="window.location.href='alterarddosbeneficiarios.html?id=${b.id}'">Editar</button>
                        
                        <button class="btn-acao btn-excluir" onclick="excluir(${b.id})">Excluir</button>
                    </td>
                `;
                tabela.appendChild(linha);
            });
        }

        window.excluir = async function(id) {
            if (confirm("Deseja realmente excluir este benefici√°rio?")) {
                const { error } = await supabase.from('beneficiarios').delete().eq('id', id);
                
                if (error) {
                    // Prote√ß√£o contra exclus√£o se tiver entregas vinculadas
                    if (error.code === '23503') {
                        alert("üö´ IMPOSS√çVEL EXCLUIR!\n\nEsta crian√ßa/fam√≠lia j√° recebeu entregas registradas.\nPara manter o hist√≥rico, o registro n√£o pode ser apagado.");
                    } else {
                        alert("Erro: " + error.message);
                    }
                } else {
                    alert("‚úÖ Exclu√≠do com sucesso!");
                    carregarTabela();
                }
            }
        }

        carregarTabela();
    </script>
</body>
</html>