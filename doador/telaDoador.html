<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alvorecer Digital - Cadastro de Doador</title>
    <style>
        body { font-family: Arial, sans-serif; background: #e8f1ff; margin: 0; padding: 20px; }
        .topo { text-align: center; background: #1e4fa8; color: white; padding: 20px; margin-bottom: 30px; border-radius: 10px; }
        .btn-inicio { display: inline-block; margin-bottom: 20px; padding: 10px 15px; background: #b0c4de; text-decoration: none; color: #333; border-radius: 5px; font-weight: bold; }
        .form-container { display: flex; justify-content: center; padding: 0; }
        .formulario { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0px 0px 10px #00000020; }
        .formulario label { font-weight: bold; }
        .formulario input { padding: 10px; border: 1px solid #bbb; border-radius: 8px; font-size: 15px; }
        .btn-primario { background: #1e4fa8; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 16px; font-weight: bold; }
        .btn-primario:hover { background: #163d7f; }
        .btn-cancelar { background: #d43535; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; margin-top: 5px; font-size: 16px; font-weight: bold; }
        .btn-cancelar:hover { background: #a71d2a; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <a href="../telainicial.html" class="btn-inicio">⬅ Voltar ao Início</a>

    <header class="topo">
        <h1>Alvorecer Digital</h1>
        <h2 id="tituloTela">Cadastro de Doador</h2> </header>

    <main class="form-container">
        <form id="formDoador" class="formulario">
            <input type="hidden" id="idDoador">

            <label>Nome Completo</label>
            <input type="text" id="nome">

            <label>CPF</label>
            <input type="text" id="cpf" placeholder="000.000.000-00">

            <label>Telefone</label>
            <input type="text" id="telefone" placeholder="(00) 00000-0000">

            <label>Endereço</label>
            <input type="text" id="endereco">

            <label>E-mail</label>
            <input type="email" id="email">

            <button type="submit" class="btn-primario" id="btnSalvar">Salvar Doador</button>
            <button type="button" class="btn-cancelar" onclick="cancelar()">Cancelar</button>
        </form>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

       // CHAVES DE CONEXÃO COM O BANCO DE DADOS
        const supabaseUrl = 'https://qmbkynoymgmwjxjelkoc.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYmt5bm95bWdtd2p4amVsa29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNTkzMjgsImV4cCI6MjA3OTgzNTMyOH0.1aS3mB0md0T2BLMfYasCA9ZCgybvKEjV0qXZE6FV_wA'
        const supabase = createClient(supabaseUrl, supabaseKey)

        const form = document.getElementById('formDoador');
        const btnSalvar = document.getElementById('btnSalvar');
        const tituloTela = document.getElementById("tituloTela");

        async function verificarEdicao() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (id) {
                tituloTela.innerText = "Editar Doador";
                btnSalvar.innerText = "Atualizar Cadastro";
                document.getElementById("idDoador").value = id;

                const { data, error } = await supabase
                    .from('doadores')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (data) {
                    document.getElementById("nome").value = data.nome;
                    document.getElementById("cpf").value = data.cpf;
                    document.getElementById("telefone").value = data.telefone;
                    document.getElementById("endereco").value = data.endereco;
                    document.getElementById("email").value = data.email;
                }
            }
        }

        // --- 2. SALVAR (INSERT ou UPDATE) ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById("idDoador").value;
            const nome = document.getElementById("nome").value;
            const cpf = document.getElementById("cpf").value;
            const telefone = document.getElementById("telefone").value;
            const endereco = document.getElementById("endereco").value;
            const email = document.getElementById("email").value;

            if (!nome || !cpf) { alert("Nome e CPF são obrigatórios!"); return; }

            btnSalvar.innerText = "Salvando...";
            form.classList.add("loading");

            let error = null;

            if (id) {
                // --- MODO UPDATE (Atualizar) ---
                const response = await supabase
                    .from('doadores')
                    .update({ nome, cpf, telefone, endereco, email })
                    .eq('id', id);
                error = response.error;
            } else {
                const response = await supabase
                    .from('doadores')
                    .insert([{ nome, cpf, telefone, endereco, email }]);
                error = response.error;
            }

            form.classList.remove("loading");

            if (error) {
                alert("Erro ao salvar: " + error.message);
                btnSalvar.innerText = id ? "Atualizar Cadastro" : "Salvar Doador";
            } else {
                alert("✅ Sucesso!");
                window.location.href = "doador.html";
            }
        });

        window.cancelar = function() {
            window.location.href = "doador.html";
        }

        verificarEdicao();
    </script>

</body>
</html>